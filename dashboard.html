<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel de Classifica√ß√£o de Risco</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body {
      background: #f4f8fb;
      font-family: "Poppins", sans-serif;
    }

    h2 {
      color: #004b8d;
      margin-bottom: 10px;
      font-weight: 600;
    }

    #ultimaAtualizacao {
      color: #666;
      font-size: 14px;
      margin-bottom: 25px;
    }

    .btn-outline-primary {
      border-color: #004b8d;
      color: #004b8d;
      font-weight: 500;
    }

    .btn-outline-primary:hover {
      background: #004b8d;
      color: white;
    }

    .card {
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      background: white;
    }

    .table thead {
      background: #004b8d;
      color: white;
    }

    .no-data {
      text-align: center;
      color: #888;
      padding: 20px;
    }

    .filter-select {
      max-width: 250px;
    }

    /* Layout dos gr√°ficos */
    .charts-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 40px;
    }

    .chart-box {
      flex: 1;
      min-width: 350px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      padding: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 420px;
    }

    .chart-box canvas {
      width: 95% !important;
      height: 95% !important;
    }

    /* Indicadores */
    .indicator-card {
      text-align: center;
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      height: 100%;
    }

    .indicator-card h5 {
      color: #555;
    }

    .indicator-card h2 {
      color: #004b8d;
      font-weight: bold;
      margin: 0;
    }

    table td, table th {
      vertical-align: middle;
      text-align: center;
      font-size: 14px;
    }

    table td span {
      font-weight: bold;
    }
  </style>
</head>

<body class="p-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>üìä Painel de Classifica√ß√£o de Risco</h2>
    <div>
      <select id="filtroClassificacao" class="form-select filter-select d-inline-block me-2">
        <option value="Todos">Todas as Classifica√ß√µes</option>
        <option value="Azul">Azul</option>
        <option value="Verde">Verde</option>
        <option value="Amarelo">Amarelo</option>
        <option value="Laranja">Laranja</option>
        <option value="Vermelho">Vermelho</option>
      </select>
      <a href="index.html" class="btn btn-outline-primary">
        <span class="material-icons" style="vertical-align: middle;">arrow_back</span> Voltar para Formul√°rio
      </a>
    </div>
  </div>

  <div id="ultimaAtualizacao">√öltima atualiza√ß√£o: --:--:--</div>

  <!-- Indicadores -->
  <div class="row mb-4 g-4">
    <div class="col-md-4"><div class="indicator-card"><h5>Total de Classifica√ß√µes</h5><h2 id="totalClassificacoes">0</h2></div></div>
    <div class="col-md-4"><div class="indicator-card"><h5>M√©dia de Idade</h5><h2 id="mediaIdade">0</h2></div></div>
    <div class="col-md-4"><div class="indicator-card"><h5>M√©dia de Dor</h5><h2 id="mediaDor">0</h2></div></div>
  </div>

  <!-- Gr√°ficos -->
  <div class="charts-row">
    <div class="chart-box">
      <canvas id="graficoDor"></canvas>
    </div>
    <div class="chart-box">
      <canvas id="graficoClassificacao"></canvas>
    </div>
  </div>

  <!-- Tabela -->
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Idade</th>
          <th>Sexo</th>
          <th>PAS</th>
          <th>PAD</th>
          <th>FC</th>
          <th>FR</th>
          <th>Temp</th>
          <th>SpO‚ÇÇ</th>
          <th>HGT</th>
          <th>Dor</th>
          <th>Express√£o</th>
          <th>Fala</th>
          <th>Bra√ßos</th>
          <th>Queixa</th>
          <th>Classifica√ß√£o</th>
        </tr>
      </thead>
      <tbody id="tabelaDados">
        <tr><td colspan="16" class="no-data">Nenhum registro encontrado</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRqPtIJfWRRrri7Kig3n_A6ER21c_XIpLY8bf-SNNgQkTApSxl8iBlDllMbIjVdyGAWoBddefTrDSGd/pub?output=csv";

    let todosDados = [];
    let graficoDor, graficoClassificacao;

    async function carregarDados() {
      try {
        const res = await fetch(sheetURL);
        const texto = await res.text();
        const linhas = texto.split("\n").map(l => l.split(","));
        todosDados = linhas.filter(r => r[0]?.trim() !== "");
        atualizarDashboard("Todos");

        // Atualiza o hor√°rio da √∫ltima atualiza√ß√£o
        const agora = new Date();
        const hora = agora.toLocaleTimeString("pt-BR", {hour12:false});
        document.getElementById("ultimaAtualizacao").textContent = "√öltima atualiza√ß√£o: " + hora;
      } catch (e) {
        console.error("Erro ao carregar CSV:", e);
      }
    }

    function atualizarDashboard(filtro) {
      const dados = filtro === "Todos" ? todosDados.slice(1) : todosDados.slice(1).filter(r => r[12] === filtro);

      document.getElementById("totalClassificacoes").textContent = dados.length || 0;

      const idades = dados.map(r => parseInt(r[2])).filter(n => !isNaN(n));
      const dores = dados.map(r => parseInt(r[11])).filter(n => !isNaN(n));

      const mediaIdade = idades.length ? (idades.reduce((a,b)=>a+b,0)/idades.length) : 0;
      const mediaDor = dores.length ? (dores.reduce((a,b)=>a+b,0)/dores.length) : 0;

      document.getElementById("mediaIdade").textContent = Math.round(mediaIdade);
      document.getElementById("mediaDor").textContent = Math.round(mediaDor);

      // === Gr√°fico de Dor ===
      const ctxDor = document.getElementById("graficoDor");
      const distDor = dores.reduce((acc,v)=>{acc[v]=(acc[v]||0)+1;return acc;}, {});
      if (graficoDor) graficoDor.destroy();
      graficoDor = new Chart(ctxDor,{
        type:'bar',
        data:{
          labels:Object.keys(distDor).length ? Object.keys(distDor) : ["Sem dados"],
          datasets:[{
            label:'Distribui√ß√£o da Escala de Dor',
            data:Object.values(distDor).length ? Object.values(distDor) : [0],
            backgroundColor:'#007bff'
          }]
        },
        options:{
          plugins:{legend:{display:false}},
          scales:{y:{beginAtZero:true, ticks:{stepSize:1}}}
        }
      });

      // === Gr√°fico de Classifica√ß√£o ===
      const ctxClass = document.getElementById("graficoClassificacao");
      const cores = ['#00b0f0','#00b050','#ffc000','#ed7d31','#c00000'];
      const labelsClass = ['Azul','Verde','Amarelo','Laranja','Vermelho'];
      const contagem = {Azul:0,Verde:0,Amarelo:0,Laranja:0,Vermelho:0};
      dados.forEach(r => {
        const c = r[12]?.trim();
        if (contagem[c] !== undefined) contagem[c]++;
      });
      if (graficoClassificacao) graficoClassificacao.destroy();
      graficoClassificacao = new Chart(ctxClass,{
        type:'doughnut',
        data:{
          labels:labelsClass,
          datasets:[{
            data:Object.values(contagem),
            backgroundColor:cores
          }]
        },
        options:{
          animation:{duration:800,easing:'easeInOutQuart'},
          plugins:{
            legend:{
              position:'bottom',
              labels:{
                font:{size:11},
                padding:10
              }
            },
            title:{
              display:true,
              text:'Distribui√ß√£o por Classifica√ß√£o de Risco',
              font:{size:14, weight:'600'},
              padding:{bottom:10}
            }
          }
        }
      });

      // === Tabela completa ===
      const tbody = document.getElementById("tabelaDados");
      tbody.innerHTML = "";
      if (dados.length === 0) {
        tbody.innerHTML = `<tr><td colspan="16" class="no-data">Nenhum registro encontrado</td></tr>`;
      } else {
        dados.forEach(r=>{
          const row = `<tr>
            <td>${r[1] || "-"}</td>
            <td>${r[2] || "-"}</td>
            <td>${r[3] || "-"}</td>
            <td>${r[4] || "-"}</td>
            <td>${r[5] || "-"}</td>
            <td>${r[6] || "-"}</td>
            <td>${r[7] || "-"}</td>
            <td>${r[8] || "-"}</td>
            <td>${r[9] || "-"}</td>
            <td>${r[13] || "-"}</td>
            <td>${r[11] || "-"}</td>
            <td>${r[14] || "-"}</td>
            <td>${r[15] || "-"}</td>
            <td>${r[16] || "-"}</td>
            <td>${r[10] || "-"}</td>
            <td><span style="color:${corClassificacao(r[12])}">${r[12] || "-"}</span></td>
          </tr>`;
          tbody.innerHTML += row;
        });
      }
    }

    function corClassificacao(cor) {
      switch(cor) {
        case "Azul": return "#00b0f0";
        case "Verde": return "#00b050";
        case "Amarelo": return "#ffc000";
        case "Laranja": return "#ed7d31";
        case "Vermelho": return "#c00000";
        default: return "#000";
      }
    }

    document.getElementById("filtroClassificacao").addEventListener("change", (e)=>{
      atualizarDashboard(e.target.value);
    });

    carregarDados();
    setInterval(carregarDados, 30000);
  </script>
</body>
</html>
