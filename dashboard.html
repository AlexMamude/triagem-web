<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel de Classifica√ß√£o de Risco</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body {
      background: #f4f8fb;
      font-family: "Poppins", sans-serif;
    }
    h2 { color:#004b8d;font-weight:600;margin-bottom:10px; }
    #ultimaAtualizacao { color:#666;font-size:14px;margin-bottom:25px; }
    .table thead { background:#004b8d;color:white; }
    .table td, .table th { text-align:center;vertical-align:middle;font-size:14px; }
    .chart-box { flex:1;min-width:350px;background:white;border-radius:15px;box-shadow:0 4px 10px rgba(0,0,0,0.05);padding:25px;display:flex;align-items:center;justify-content:center;height:420px; }
    .indicator-card { background:white;border-radius:15px;box-shadow:0 4px 10px rgba(0,0,0,0.05);text-align:center;padding:20px; }
    .indicator-card h2 { color:#004b8d;font-weight:bold;margin:0; }
  </style>
</head>
<body class="p-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>üìä Painel de Classifica√ß√£o de Risco</h2>
    <div>
      <select id="filtroClassificacao" class="form-select d-inline-block me-2" style="max-width:250px;">
        <option value="Todos">Todas as Classifica√ß√µes</option>
        <option value="Azul">Azul</option>
        <option value="Verde">Verde</option>
        <option value="Amarelo">Amarelo</option>
        <option value="Laranja">Laranja</option>
        <option value="Vermelho">Vermelho</option>
      </select>
      <a href="index.html" class="btn btn-outline-primary">‚Üê Voltar</a>
    </div>
  </div>

  <div id="ultimaAtualizacao">√öltima atualiza√ß√£o: --:--:--</div>

  <!-- Indicadores -->
  <div class="row mb-4 g-4">
    <div class="col-md-4"><div class="indicator-card"><h5>Total</h5><h2 id="totalClassificacoes">0</h2></div></div>
    <div class="col-md-4"><div class="indicator-card"><h5>M√©dia de Idade</h5><h2 id="mediaIdade">0</h2></div></div>
    <div class="col-md-4"><div class="indicator-card"><h5>M√©dia de Dor</h5><h2 id="mediaDor">0</h2></div></div>
  </div>

  <!-- Gr√°ficos -->
  <div class="d-flex flex-wrap gap-3 mb-4">
    <div class="chart-box"><canvas id="graficoDor"></canvas></div>
    <div class="chart-box"><canvas id="graficoClassificacao"></canvas></div>
  </div>

  <!-- Tabela -->
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th>Nome</th><th>Idade</th><th>Sexo</th>
          <th>PAS</th><th>PAD</th><th>FC</th><th>FR</th><th>Temp</th><th>SpO‚ÇÇ</th><th>HGT</th>
          <th>Dor</th><th>Express√£o</th><th>Fala</th><th>Bra√ßos</th><th>Queixa</th><th>Classifica√ß√£o</th>
        </tr>
      </thead>
      <tbody id="tabelaDados"><tr><td colspan="16" class="text-center text-muted">Nenhum registro encontrado</td></tr></tbody>
    </table>
  </div>

  <script>
    const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRqPtIJfWRRrri7Kig3n_A6ER21c_XIpLY8bf-SNNgQkTApSxl8iBlDllMbIjVdyGAWoBddefTrDSGd/pub?output=csv";
    let todosDados = [];
    let graficoDor, graficoClassificacao;

    async function carregarDados() {
      const res = await fetch(sheetURL);
      const texto = await res.text();
      const linhas = texto.split("\n").map(l => l.split(","));
      todosDados = linhas.slice(1).filter(r => r[0]?.trim());
      atualizarDashboard("Todos");

      document.getElementById("ultimaAtualizacao").textContent =
        "√öltima atualiza√ß√£o: " + new Date().toLocaleTimeString("pt-BR", { hour12: false });
    }

    function atualizarDashboard(filtro) {
      const dados = filtro === "Todos" ? todosDados : todosDados.filter(r => r[12] === filtro);
      document.getElementById("totalClassificacoes").textContent = dados.length;

      const idades = dados.map(r => parseInt(r[2])).filter(n => !isNaN(n));
      const dores = dados.map(r => parseInt(r[11])).filter(n => !isNaN(n));

      document.getElementById("mediaIdade").textContent = Math.round(idades.reduce((a, b) => a + b, 0) / (idades.length || 1));
      document.getElementById("mediaDor").textContent = Math.round(dores.reduce((a, b) => a + b, 0) / (dores.length || 1));

      // === üìä Gr√°fico Escala de Dor ===
      const ctx1 = document.getElementById("graficoDor");
      const dist = dores.reduce((a, v) => { a[v] = (a[v] || 0) + 1; return a; }, {});
      if (graficoDor) graficoDor.destroy();
      graficoDor = new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: Object.keys(dist).length ? Object.keys(dist) : ["Sem dados"],
          datasets: [{
            data: Object.values(dist).length ? Object.values(dist) : [0],
            backgroundColor: '#007bff'
          }]
        },
        options: {
          plugins: {
            legend: { display: false },
            title: {
              display: true,
              text: 'Escala de Dor',
              font: { size: 14, weight: '600' },
              padding: { bottom: 10 }
            }
          },
          scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
      });

      // === üìä Gr√°fico de Classifica√ß√£o de Risco ===
      const ctx2 = document.getElementById("graficoClassificacao");
      const cores = ['#00b0f0', '#00b050', '#ffc000', '#ed7d31', '#c00000'];
      const classes = ['Azul', 'Verde', 'Amarelo', 'Laranja', 'Vermelho'];
      const contagem = { Azul: 0, Verde: 0, Amarelo: 0, Laranja: 0, Vermelho: 0 };
      dados.forEach(r => { const c = r[12]?.trim(); if (contagem[c] !== undefined) contagem[c]++; });

      if (graficoClassificacao) graficoClassificacao.destroy();
      graficoClassificacao = new Chart(ctx2, {
        type: 'doughnut',
        data: {
          labels: classes,
          datasets: [{ data: Object.values(contagem), backgroundColor: cores }]
        },
        options: {
          plugins: {
            legend: {
              position: 'bottom',
              labels: { font: { size: 11 }, padding: 10 }
            },
            title: {
              display: true,
              text: 'Distribui√ß√£o por Classifica√ß√£o de Risco',
              font: { size: 14, weight: '600' },
              padding: { bottom: 10 }
            }
          },
          animation: { duration: 800, easing: 'easeInOutQuart' }
        }
      });

      // === üßæ Tabela ===
      const tbody = document.getElementById("tabelaDados");
      tbody.innerHTML = dados.map(r => `
        <tr>
          <td>${r[1] || "-"}</td><td>${r[2] || "-"}</td><td>${r[3] || "-"}</td>
          <td>${r[4] || "-"}</td><td>${r[5] || "-"}</td><td>${r[6] || "-"}</td>
          <td>${r[7] || "-"}</td><td>${r[8] || "-"}</td><td>${r[9] || "-"}</td><td>${r[13] || "-"}</td>
          <td>${r[11] || "-"}</td><td>${r[14] || "-"}</td><td>${r[15] || "-"}</td>
          <td>${r[16] || "-"}</td><td>${r[10] || "-"}</td>
          <td><span style="color:${corClassificacao(r[12])}">${r[12] || "-"}</span></td>
        </tr>
      `).join('') || `<tr><td colspan="16" class="text-center text-muted">Nenhum registro encontrado</td></tr>`;
    }

    function corClassificacao(c) {
      return { Azul: "#00b0f0", Verde: "#00b050", Amarelo: "#ffc000", Laranja: "#ed7d31", Vermelho: "#c00000" }[c] || "#000";
    }

    document.getElementById("filtroClassificacao").addEventListener("change", e => atualizarDashboard(e.target.value));
    carregarDados();
    setInterval(carregarDados, 30000);
  </script>
</body>
</html>
