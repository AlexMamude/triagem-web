<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel de Classifica√ß√£o de Risco</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body {
      background: #f4f8fb;
      font-family: "Poppins", sans-serif;
    }

    h2 {
      color: #004b8d;
      margin-bottom: 20px;
      font-weight: 600;
    }

    .btn-outline-primary {
      border-color: #004b8d;
      color: #004b8d;
      font-weight: 500;
    }

    .btn-outline-primary:hover {
      background: #004b8d;
      color: white;
    }

    .card {
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    .table thead {
      background: #004b8d;
      color: white;
    }

    .no-data {
      text-align: center;
      color: #888;
      padding: 20px;
    }

    .filter-select {
      max-width: 250px;
    }

    /* === NOVO: padroniza os tamanhos dos quadrantes dos gr√°ficos === */
    .chart-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      padding: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      aspect-ratio: 1 / 1; /* mant√©m propor√ß√£o quadrada */
      max-height: 400px;   /* limita altura m√°xima */
      margin: auto;
    }

    .chart-container canvas {
      width: 90% !important;
      height: auto !important;
      max-height: 90% !important;
    }
  </style>
</head>

<body class="p-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>üìä Painel de Classifica√ß√£o de Risco</h2>
    <div>
      <select id="filtroClassificacao" class="form-select filter-select d-inline-block me-2">
        <option value="Todos">Todas as Classifica√ß√µes</option>
        <option value="Azul">Azul</option>
        <option value="Verde">Verde</option>
        <option value="Amarelo">Amarelo</option>
        <option value="Laranja">Laranja</option>
        <option value="Vermelho">Vermelho</option>
      </select>
      <a href="index.html" class="btn btn-outline-primary">
        <span class="material-icons" style="vertical-align: middle;">arrow_back</span> Voltar para Formul√°rio
      </a>
    </div>
  </div>

  <!-- Indicadores -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card p-3 text-center">
        <h5>Total de Classifica√ß√µes</h5>
        <h2 id="totalClassificacoes">0</h2>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3 text-center">
        <h5>M√©dia de Idade</h5>
        <h2 id="mediaIdade">0</h2>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3 text-center">
        <h5>M√©dia de Dor</h5>
        <h2 id="mediaDor">0</h2>
      </div>
    </div>
  </div>

  <!-- Gr√°ficos -->
  <div class="row g-4 mb-4">
    <div class="col-md-6">
      <div class="chart-container">
        <canvas id="graficoDor"></canvas>
      </div>
    </div>
    <div class="col-md-6">
      <div class="chart-container">
        <canvas id="graficoClassificacao"></canvas>
      </div>
    </div>
  </div>

  <!-- Tabela -->
  <table class="table table-striped table-hover">
    <thead>
      <tr>
        <th>Nome</th>
        <th>Idade</th>
        <th>Dor</th>
        <th>Queixa</th>
        <th>FC</th>
        <th>Temp</th>
        <th>Classifica√ß√£o</th>
      </tr>
    </thead>
    <tbody id="tabelaDados">
      <tr><td colspan="7" class="no-data">Nenhum registro encontrado</td></tr>
    </tbody>
  </table>

  <script>
    const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRqPtIJfWRRrri7Kig3n_A6ER21c_XIpLY8bf-SNNgQkTApSxl8iBlDllMbIjVdyGAWoBddefTrDSGd/pub?output=csv";

    let todosDados = [];
    let graficoDor, graficoClassificacao;

    async function carregarDados() {
      const res = await fetch(sheetURL);
      const texto = await res.text();
      const linhas = texto.split("\n").map(l => l.split(","));
      todosDados = linhas.slice(1).filter(r => r[0].trim() !== "");
      atualizarDashboard("Todos");
    }

    function atualizarDashboard(filtro) {
      const dados = filtro === "Todos" ? todosDados : todosDados.filter(r => r[12] === filtro);

      // Indicadores principais
      document.getElementById("totalClassificacoes").textContent = dados.length || 0;

      const idades = dados.map(r => parseInt(r[2])).filter(n => !isNaN(n));
      const dores = dados.map(r => parseInt(r[11])).filter(n => !isNaN(n));

      const mediaIdade = idades.length ? (idades.reduce((a,b)=>a+b,0)/idades.length) : 0;
      const mediaDor = dores.length ? (dores.reduce((a,b)=>a+b,0)/dores.length) : 0;

      document.getElementById("mediaIdade").textContent = Math.round(mediaIdade) || 0;
      document.getElementById("mediaDor").textContent = Math.round(mediaDor) || 0;

      // === Gr√°fico de Dor ===
      const ctxDor = document.getElementById("graficoDor");
      const distDor = dores.reduce((acc,v)=>{acc[v]=(acc[v]||0)+1;return acc;}, {});
      if (graficoDor) graficoDor.destroy();
      graficoDor = new Chart(ctxDor,{
        type:'bar',
        data:{
          labels:Object.keys(distDor).length ? Object.keys(distDor) : ["Sem dados"],
          datasets:[{
            label:'Distribui√ß√£o da Escala de Dor',
            data:Object.values(distDor).length ? Object.values(distDor) : [0],
            backgroundColor:'#007bff'
          }]
        },
        options:{
          plugins:{legend:{display:false}},
          scales:{y:{beginAtZero:true, ticks:{stepSize:1}}}
        }
      });

      // === Gr√°fico de Classifica√ß√£o ===
      const ctxClass = document.getElementById("graficoClassificacao");
      const cores = ['#00b0f0','#00b050','#ffc000','#ed7d31','#c00000'];
      const labelsClass = ['Azul','Verde','Amarelo','Laranja','Vermelho'];
      const contagem = {Azul:0,Verde:0,Amarelo:0,Laranja:0,Vermelho:0};
      todosDados.forEach(r => {
        if (contagem[r[12]] !== undefined) contagem[r[12]]++;
      });
      if (graficoClassificacao) graficoClassificacao.destroy();
      graficoClassificacao = new Chart(ctxClass,{
        type:'doughnut',
        data:{
          labels:labelsClass,
          datasets:[{
            data:Object.values(contagem),
            backgroundColor:cores
          }]
        },
        options:{
          plugins:{
            legend:{position:'bottom'},
            title:{display:true,text:'Distribui√ß√£o por Classifica√ß√£o de Risco'}
          }
        }
      });

      // === Tabela ===
      const tbody = document.getElementById("tabelaDados");
      tbody.innerHTML = "";
      if (dados.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="no-data">Nenhum registro encontrado</td></tr>`;
      } else {
        dados.forEach(r=>{
          const row = `<tr>
            <td>${r[1] || "-"}</td>
            <td>${r[2] || "0"}</td>
            <td>${r[11] || "0"}</td>
            <td>${r[10] || "-"}</td>
            <td>${r[6] || "0"}</td>
            <td>${r[9] || "0"}</td>
            <td><span style="font-weight:bold;color:${corClassificacao(r[12])}">${r[12] || "-"}</span></td>
          </tr>`;
          tbody.innerHTML += row;
        });
      }
    }

    function corClassificacao(cor) {
      switch(cor) {
        case "Azul": return "#00b0f0";
        case "Verde": return "#00b050";
        case "Amarelo": return "#ffc000";
        case "Laranja": return "#ed7d31";
        case "Vermelho": return "#c00000";
        default: return "#000";
      }
    }

    document.getElementById("filtroClassificacao").addEventListener("change", (e)=>{
      atualizarDashboard(e.target.value);
    });

    carregarDados();
  </script>
</body>
</html>

